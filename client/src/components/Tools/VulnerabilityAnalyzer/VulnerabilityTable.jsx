import React, { useState, useEffect } from "react";
import {
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  Paper,
} from "@mui/material";
import { orderBy } from "lodash";

const VulnerabilityTable = ({ vulnerabilityData }) => {
  const [sortedData, setSortedData] = useState([]);
  const [sortKey, setSortKey] = useState("Total");
  const [sortOrder, setSortOrder] = useState("desc");

  useEffect(() => {
    const sorted = orderBy(
      Object.keys(vulnerabilityData).map((host) => ({
        Host: host,
        ...vulnerabilityData[host],
        Total:
          vulnerabilityData[host].Critical +
          vulnerabilityData[host].High +
          vulnerabilityData[host].Medium +
          vulnerabilityData[host].Low +
          vulnerabilityData[host].Unavailable,
      })),
      sortKey,
      sortOrder
    );
    setSortedData(sorted);
  }, [vulnerabilityData, sortKey, sortOrder]);

  const handleSort = (key) => {
    if (key === sortKey) {
      setSortOrder(sortOrder === "asc" ? "desc" : "asc");
    } else {
      setSortKey(key);
      setSortOrder("desc");
    }
  };

  const calculateTotalRow = () => {
    const totalRow = {
      Host: "Всего",
      Critical: 0,
      High: 0,
      Medium: 0,
      Low: 0,
      Unavailable: 0,
      Total: 0,
    };

    sortedData.forEach((row) => {
      totalRow.Critical += row.Critical;
      totalRow.High += row.High;
      totalRow.Medium += row.Medium;
      totalRow.Low += row.Low;
      totalRow.Unavailable += row.Unavailable;
      totalRow.Total += row.Total;
    });

    return totalRow;
  };

  const headerStyles = {
    fontWeight: "bold",
    cursor: "pointer",
    textAlign: "center",
    padding: 0,
    borderBottom: "2px solid white",
    borderRight: "2px solid white",
    color: "white",
  };
  const tableCellStyles = {
    textAlign: "center",
    backgroundColor: "#eff4fb",
    borderBottom: "2px solid white",
    borderRight: "2px solid white",
    color: "black",
    fontWeight: "400",

    padding: 0,
  };

  const dataWithTotal = [...sortedData, calculateTotalRow()];

  return (
    <TableContainer component={Paper}>
      <Table aria-label="vulnerability table">
        <TableHead>
          <TableRow>
            <TableCell
              sx={{
                ...headerStyles,
                cursor: "default",
                textAlign: "left",
                paddingLeft: 1.5,
                backgroundColor: "#d9d9d9",
                color: "black",
              }}
            >
              Хост\Риск
            </TableCell>
            <TableCell
              sx={{ ...headerStyles, backgroundColor: "#87171a" }}
              onClick={() => handleSort("Critical")}
            >
              Критический
              {sortKey === "Critical" &&
                " " + (sortOrder === "asc" ? "▲" : "▼")}
            </TableCell>
            <TableCell
              sx={{ ...headerStyles, backgroundColor: "#cc0000" }}
              onClick={() => handleSort("High")}
            >
              Высокий
              {sortKey === "High" && " " + (sortOrder === "asc" ? "▲" : "▼")}
            </TableCell>
            <TableCell
              sx={{ ...headerStyles, backgroundColor: "#f5770f" }}
              onClick={() => handleSort("Medium")}
            >
              Средний
              {sortKey === "Medium" && " " + (sortOrder === "asc" ? "▲" : "▼")}
            </TableCell>
            <TableCell
              sx={{ ...headerStyles, backgroundColor: "#00705c" }}
              onClick={() => handleSort("Low")}
            >
              Низкий
              {sortKey === "Low" && " " + (sortOrder === "asc" ? "▲" : "▼")}
            </TableCell>
            <TableCell
              sx={{ ...headerStyles, backgroundColor: "#696969" }}
              onClick={() => handleSort("Unavailable")}
            >
              Недоступно
              {sortKey === "Unavailable" &&
                " " + (sortOrder === "asc" ? "▲" : "▼")}
            </TableCell>
            <TableCell
              sx={{
                ...headerStyles,
                backgroundColor: "#d9d9d9",
                color: "black",
              }}
              onClick={() => handleSort("Total")}
            >
              Всего
              {sortKey === "Total" && " " + (sortOrder === "asc" ? "▲" : "▼")}
            </TableCell>
          </TableRow>
        </TableHead>
        <TableBody>
          {dataWithTotal.map((row, index) => (
            <TableRow key={row.Host}>
              <TableCell
                sx={{
                  ...tableCellStyles,
                  textAlign: "left",
                  paddingLeft: 1.5,
                  backgroundColor: "#d9d9d9",
                  color: "black",
                  fontWeight:
                    index === dataWithTotal.length - 1 ? "bold" : "400",
                }}
              >
                {row.Host} {row.Host !== "Всего" ? `| ${row.CPE}` : row.CPE}
              </TableCell>
              <TableCell
                sx={{
                  ...tableCellStyles,
                  fontWeight:
                    index === dataWithTotal.length - 1 ? "bold" : "400",
                }}
              >
                {row.Critical}
              </TableCell>
              <TableCell
                sx={{
                  ...tableCellStyles,
                  fontWeight:
                    index === dataWithTotal.length - 1 ? "bold" : "400",
                }}
              >
                {row.High}
              </TableCell>
              <TableCell
                sx={{
                  ...tableCellStyles,
                  fontWeight:
                    index === dataWithTotal.length - 1 ? "bold" : "400",
                }}
              >
                {row.Medium}
              </TableCell>
              <TableCell
                sx={{
                  ...tableCellStyles,
                  fontWeight:
                    index === dataWithTotal.length - 1 ? "bold" : "400",
                }}
              >
                {row.Low}
              </TableCell>
              <TableCell
                sx={{
                  ...tableCellStyles,
                  fontWeight:
                    index === dataWithTotal.length - 1 ? "bold" : "400",
                }}
              >
                {row.Unavailable}
              </TableCell>
              <TableCell
                sx={{
                  ...tableCellStyles,
                  fontWeight:
                    index === dataWithTotal.length - 1 ? "bold" : "400",
                }}
              >
                {row.Total}
              </TableCell>
            </TableRow>
          ))}
        </TableBody>
      </Table>
    </TableContainer>
  );
};

export default VulnerabilityTable;
